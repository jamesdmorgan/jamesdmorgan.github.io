---
layout: post
title: Ansible snippets and tips
description: "Ansible "
modified: 2014-11-05
category: continuous-delivery
tags: [ansible, python, jinja2, yaml]
---

<section id="table-of-contents" class="toc">
  <header>
    <h3>Contents</h3>
  </header>
<div id="drawer" markdown="1">
*  Auto generated table of contents
{:toc}
</div>
</section><!-- /#table-of-contents -->

#### Accessing variables programatically

The [Ansible FAQ]( http://docs.ansible.com/faq.html) details how to build up varibles
programatically.

{% highlight python %}
{% raw %}
{{ hostvars[inventory_hostname]['ansible_' + which_interface]['ipv4']['address'] }}
{% endraw %}
{% endhighlight %}

In order to access concatenated variables they need to be in the inventory. This doesn't happen with
vars inline in the playbook but does work if you use *include_vars*

{% highlight yaml linenos%}
- hosts: localhost
  connection: local
  vars:
    test_app: admin
  tasks:
    - include_vars: concat_vars.yml
    - debug:
        msg: "admin port from inventory = {{ hostvars[inventory_hostname][test_app+'_port'] }}
{% endhighlight %}


{% highlight yaml %}
admin_port: 1000
{% highlight yaml %}

{% highlight bash %}
TASK: [debug ] ****************************************************************
ok: [localhost] => {
    "msg": "admin port from inventory = 1000"
}
{% endhighlight %}


#### Dictionaries

The following example shows how you can iterate over a dict and access directly

{% highlight yaml linenos%}
{% raw %}
- hosts: localhost
  connection: local
  vars:
    apps:
      admin:
        service: admin
        handler: /admin
        port: 1200
      rpt:
        service: rpt
        handler: /rpt
        port: 1234
  tasks:
    - debug:
        msg: "{{ item.key }} -- {{ item.value.service }} {{ item.value.port }}"
      with_dict: apps

    - debug:
        msg: "{{ apps.admin.service }}"
{% endraw %}
{% endhighlight %}

{% highlight json %}
{% raw %}
TASK: [debug ] ****************************************************************
ok: [localhost] => (item={'key': 'admin', 'value': {'handler': '/admin', 'port': 1200, 'service': 'admin'}}) => {
    "item": {
        "key": "admin",
        "value": {
            "handler": "/admin",
            "port": 1200,
            "service": "admin"
        }
    },
    "msg": "admin -- admin 1200"
}
ok: [localhost] => (item={'key': 'rpt', 'value': {'handler': '/rpt', 'port': 1234, 'service': 'rpt'}}) => {
    "item": {
        "key": "rpt",
        "value": {
            "handler": "/rpt",
            "port": 1234,
            "service": "rpt"
        }
    },
    "msg": "rpt -- rpt 1234"
}
{% endraw %}
{% endhighlight %}


